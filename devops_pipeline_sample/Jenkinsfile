pipeline {
  agent any

  environment {
    // Jenkins credentials IDs must be configured in Jenkins
    AWS_ACCESS_KEY_ID = credentials('aws-access-key-id')
    AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
    SSH_CRED_ID = 'ssh-deploy-key' // replace with your Jenkins SSH credential id
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build') {
      steps {
        dir('app') {
          sh 'npm install --no-audit --no-fund'
        }
      }
    }

    stage('Test') {
      steps {
        echo 'No tests included in sample. Add your test commands here.'
      }
    }

    stage('Terraform Init & Plan') {
      steps {
        dir('infra') {
          sh 'terraform init -input=false'
          sh 'terraform plan -out=tfplan -input=false'
          sh 'terraform show -no-color tfplan > tfplan.txt || true'
          archiveArtifacts artifacts: 'tfplan.txt', allowEmptyArchive: true
        }
      }
    }

    stage('Terraform Apply') {
      when {
        expression { return env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'develop' }
      }
      steps {
        dir('infra') {
          sh 'terraform apply -input=false -auto-approve tfplan'
        }
      }
    }

    stage('Package Artifact') {
      steps {
        sh 'mkdir -p build && cp -r app/* build/ || true'
        archiveArtifacts artifacts: 'build/**', allowEmptyArchive: false
      }
    }

    stage('Deploy') {
      steps {
        script {
          def deployHost = "REPLACE_WITH_APP_IP"
          sh '''
            echo "Copying artifact to server (example, will fail until configured)..."
            # scp -i /var/jenkins_home/.ssh/deploy_key build/app/* ubuntu@${deployHost}:/home/ubuntu/
            echo "Restart app service on server (ssh key/host must be configured)"
            # ssh -i /var/jenkins_home/.ssh/deploy_key ubuntu@${deployHost} 'sudo systemctl restart myapp'
          '''
        }
      }
    }
  }

  post {
    success {
      echo 'Pipeline completed successfully.'
    }
    failure {
      echo 'Pipeline failed.'
    }
  }
}